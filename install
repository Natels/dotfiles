#!/usr/bin/env bash
set -e

git --version

if [[ -z "$GITHUB_USER" ]]; then
    echo -n "GitHub user: "
    read GITHUB_USER
fi

if [[ -z "$GITHUB_USER" ]]; then
    echo "GITHUB_USER not defined."
    exit 1
fi

if [[ -z "$LASTPASS_EMAIL" ]]; then
    echo -n "LastPass email: "
    read LASTPASS_EMAIL
fi

if [[ -z "$LASTPASS_EMAIL" ]]; then
    echo "LASTPASS_EMAIL not defined."
    exit 1
fi

DOTFILES_PATH="$HOME/grit/github.com/$GITHUB_USER/dotfiles"

if [[ -d "$DOTFILES_PATH" ]]; then
    echo "Pulling $GITHUB_USER/dotfiles..."
    pushd "$DOTFILES_PATH" > /dev/null
    git pull
    popd > /dev/null
else
    echo "Cloning $GITHUB_USER/dotfiles..."
    git clone "https://github.com/$GITHUB_USER/dotfiles.git" "$DOTFILES_PATH"
fi

if hash brew 2>/dev/null; then
    echo "Homebrew already installed."
else
    echo "Installing Homebrew..."
    /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

if hash lpass 2>/dev/null; then
    echo "LastPass CLI already installed."
else
    echo "Installing LastPass CLI..."
    brew install lastpass-cli --with-pinentry
fi

lpass login "$LASTPASS_EMAIL"

echo "Fetching GitHub token from LastPass..."
export GITHUB_TOKEN="$(lpass show "Personal/GitHub token" --notes)"
export HOMEBREW_GITHUB_API_TOKEN="$GITHUB_TOKEN"
echo 'export GITHUB_TOKEN="'"$GITHUB_TOKEN"'"' >> "$HOME/.zshenv.secure"

if [ -f "$HOME/.ssh/id_rsa" ]; then
    echo "SSH key already exists."
else
    echo "Fetching SSH key from LastPass..."
    mkdir -p "$HOME/.ssh"
    lpass show "Personal/SSH" --field "Private Key" \
        | awk '/^[A-Za-z-]+:$/ { printf("%s ", $0); next } 1' \
        > "$HOME/.ssh/id_rsa"
    lpass show "Personal/SSH" --field "Public Key" \
        | awk '/^[A-Za-z-]+:$/ { printf("%s ", $0); next } 1' \
        > "$HOME/.ssh/id_rsa.pub"
    chmod 600 "$HOME/.ssh/id_rsa" "$HOME/.ssh/id_rsa.pub"
fi

SUBLIME_CONFIG_PATH="$HOME/Library/Application Support/Sublime Text 3/Local"

if [ -f "$SUBLIME_CONFIG_PATH/License.sublime_license" ]; then
    echo "Sublime Text license already exists."
else
    echo "Fetching Sublime Text license from LastPass..."
    mkdir -p "$SUBLIME_CONFIG_PATH"
    lpass show "Personal/Sublime Text License" --notes \
        > "$SUBLIME_CONFIG_PATH/License.sublime_license"
fi

echo "Adding SSH key to keychain..."
ssh-add -K "$HOME/.ssh/id_rsa"

echo "Switching dotfiles repo to SSH..."
pushd "$DOTFILES_PATH" > /dev/null
git remote set-url origin "$(git config --get remote.origin.url | sed 's/https:\/\/github.com\//git@github.com:/')"
popd > /dev/null

echo "Installing dotfiles ..."
for FILE in "$DOTFILES_PATH/dotfiles/".*; do
    NAME=$(basename $FILE)

    if [[ "." == $NAME || ".." == $NAME ]]; then
        continue
    fi

    if [ -e "$HOME/$NAME" ]; then
        echo "$NAME already exists."
    else
        echo "Linking $NAME..."
        ln -s $FILE "$HOME/$NAME"
    fi
done

if [[ -h "$HOME/zsh" ]]; then
    echo "Oh My Zsh custom directory already linked."
else
    echo "Linking Oh My Zsh custom directory..."
    ln -s "$DOTFILES_PATH/zsh" "$HOME/zsh"
fi

for FILE in "$DOTFILES_PATH/setup/"*-*.bash; do
  source "$FILE"
done

echo "Done. System must be restarted for some changes to take effect."
