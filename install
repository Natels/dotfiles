#!/usr/bin/env bash

set -e

git --version

if hash brew 2>/dev/null; then
    echo "Homebrew already installed."
else
    echo "Installing Homebrew..."
    /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

if hash jq 2>/dev/null; then
    echo "jq already installed."
else
    echo "Installing jq..."
    brew install jq
fi

if hash op 2>/dev/null; then
    echo "1Password CLI already installed."
else
    echo "Installing 1Password CLI..."
    brew cask install 1password-cli
fi

if [[ -z "$GITHUB_USER" ]]; then
    echo -n "GitHub user: "
    read GITHUB_USER
fi

if [[ -z "$GITHUB_USER" ]]; then
    echo "GITHUB_USER not defined."
    exit 1
fi

if [ -z "$OP_SESSION_my" ]; then
    while [ -z "$OP_EMAIL" ]; do
        echo -n "1Password email address: "
        read OP_EMAIL
    done

    while [ -z "$OP_KEY" ]; do
        echo -n "1Password secret key: "
        read OP_KEY
    done

    eval $(op signin my "$OP_EMAIL" "$OP_KEY")
fi

if [ -z "$OP_SESSION_my" ]; then
    echo "1Password sign in failed."
    exit 1
fi

DOTFILES_PATH="$HOME/grit/github.com/$GITHUB_USER/dotfiles"

if [[ -d "$DOTFILES_PATH" ]]; then
    echo "Pulling $GITHUB_USER/dotfiles..."
    pushd "$DOTFILES_PATH" > /dev/null
    git pull
    popd > /dev/null
else
    echo "Cloning $GITHUB_USER/dotfiles..."
    git clone "https://github.com/$GITHUB_USER/dotfiles.git" "$DOTFILES_PATH"
fi

if [[ -e "$HOME/dotfiles" ]]; then
    echo "Dotfiles shortcut directory already exists."
else
    ln -s "$DOTFILES_PATH" "$HOME/dotfiles"
fi

for FILE in "$HOME/dotfiles/setup/"*-*.bash; do
  source "$FILE"
done

echo "Done. System must be restarted for some changes to take effect."
